# Markdown Rendering Libraries

This directory contains bundled JavaScript libraries for markdown rendering and syntax highlighting in the UI Chatter Chrome extension.

## Why Local Bundling?

Chrome Extension Manifest V3 enforces strict Content Security Policy (CSP):
```
script-src 'self'; object-src 'self'
```

This policy blocks all external CDN scripts. Libraries must be bundled locally to comply with CSP requirements.

## Libraries Included

| Library | Version | Purpose |
|---------|---------|---------|
| **marked.js** | 11.1.1 | Markdown parsing |
| **DOMPurify** | 3.0.8 | HTML sanitization (XSS prevention) |
| **Prism.js** | 1.29.0 | Syntax highlighting engine |
| **Prism CSS** | 1.29.0 | Code block styling |

### Prism Language Components

- TypeScript (`.ts`)
- Python (`.py`)
- JavaScript (`.js`)
- JSX (`.jsx`)
- TSX (`.tsx`)
- JSON (`.json`)
- Bash (`.sh`)
- CSS (`.css`)

## Updating Libraries

### Automatic Update (Recommended)

Run the fetch script from the extension directory:

```bash
cd poc/extension
./fetch-libs.sh
```

The script will:
- Download all libraries from jsDelivr CDN
- Verify file integrity
- Report total size and file list
- Automatically place files in this directory

### Manual Update

1. Update version numbers in `fetch-libs.sh`:
   ```bash
   MARKED_VERSION="11.1.1"      # Update to new version
   DOMPURIFY_VERSION="3.0.8"    # Update to new version
   PRISM_VERSION="1.29.0"       # Update to new version
   ```

2. Run the script:
   ```bash
   ./fetch-libs.sh
   ```

3. Reload the extension in Chrome:
   - Go to `chrome://extensions/`
   - Click reload icon (ðŸ”„) for UI Chatter

4. Verify in DevTools Console:
   - Open side panel
   - Check for: `âœ“ Markdown libraries loaded`

### Adding New Prism Languages

To add support for additional programming languages:

1. Edit `fetch-libs.sh` and add to `PRISM_LANGUAGES` array:
   ```bash
   PRISM_LANGUAGES=(
     "typescript"
     "python"
     # ... existing languages ...
     "rust"        # Add new language
     "go"          # Add another
   )
   ```

2. Run the fetch script:
   ```bash
   ./fetch-libs.sh
   ```

3. Update `sidepanel.html` to load the new language files:
   ```html
   <script src="libs/prism-rust.min.js"></script>
   <script src="libs/prism-go.min.js"></script>
   ```

4. Reload the extension

## File Integrity

After running `fetch-libs.sh`, verify files were downloaded correctly:

```bash
ls -lh libs/
```

Expected total size: ~95KB

Files should be:
- `marked.min.js` (~34KB)
- `purify.min.js` (~21KB)
- `prism.min.js` (~19KB)
- `prism.min.css` (~1.7KB)
- `prism-*.min.js` (various sizes)

If any file is < 100 bytes, it likely failed to download. Run `fetch-libs.sh` again.

## Security Considerations

### Why DOMPurify?

DOMPurify sanitizes the HTML generated by marked.js to prevent XSS attacks. Even though markdown comes from the backend, sanitization is a defense-in-depth measure.

**Allowed tags:**
```javascript
'p', 'br', 'strong', 'em', 'code', 'pre',
'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
'ul', 'ol', 'li', 'blockquote', 'a'
```

**Allowed attributes:**
```javascript
'href', 'class', 'language-*'
```

This whitelist ensures only safe HTML elements are rendered.

### Library Sources

All libraries are downloaded from **jsDelivr CDN** (https://cdn.jsdelivr.net), which:
- Mirrors npm packages
- Provides integrity checking
- Has SLA guarantees
- Is used by millions of projects

### Version Pinning

Library versions are pinned in `fetch-libs.sh` to ensure reproducible builds and prevent unexpected breaking changes.

## Troubleshooting

### Libraries Not Loading

**Symptoms:**
- Console shows: `âŒ Markdown libraries failed to load`
- Responses show as plain text

**Solutions:**
1. Verify files exist in `libs/` directory
2. Check file sizes (should not be empty)
3. Reload extension in `chrome://extensions/`
4. Hard refresh side panel (Ctrl+Shift+R or Cmd+Shift+R)

### CSP Violations

**Symptoms:**
- Console shows: `Refused to load the script ... violates CSP directive`

**Solutions:**
1. Ensure `sidepanel.html` references local files (not CDN URLs)
2. Check script tags use `src="libs/..."` not `src="https://..."`
3. Verify manifest.json doesn't have custom CSP (should use default)

### Syntax Highlighting Not Working

**Symptoms:**
- Code blocks render but have no colors
- All text is white/default color

**Solutions:**
1. Verify Prism language component is downloaded (e.g., `prism-typescript.min.js`)
2. Check that language is included in `sidepanel.html` script tags
3. Ensure code blocks use proper markdown format: \`\`\`language
4. Check browser console for Prism-related errors

### Fetch Script Fails

**Symptoms:**
- Script exits with error
- Files are empty or < 100 bytes

**Solutions:**
1. Check internet connection
2. Try downloading manually and verify URLs work
3. Check if corporate firewall blocks jsDelivr CDN
4. Use VPN if CDN is blocked in your region

## Development

### Testing Locally

After updating libraries:

1. Reload extension
2. Navigate to test page (e.g., https://productvista.fr)
3. Select an element
4. Send message: "Explain this with code examples"
5. Verify:
   - Headers are bold and sized correctly
   - Code blocks have syntax highlighting
   - Lists are formatted
   - Links are clickable

### CI/CD Integration

To automate library updates in CI:

```yaml
# Example GitHub Actions workflow
- name: Fetch Extension Libraries
  run: |
    cd poc/extension
    ./fetch-libs.sh
```

## License Information

### marked.js
- License: MIT
- Copyright: Christopher Jeffrey
- Repository: https://github.com/markedjs/marked

### DOMPurify
- License: Apache-2.0 OR MPL-2.0
- Copyright: Cure53
- Repository: https://github.com/cure53/DOMPurify

### Prism.js
- License: MIT
- Copyright: Lea Verou
- Repository: https://github.com/PrismJS/prism

All libraries are used in compliance with their respective licenses.

## Related Documentation

- `MARKDOWN_CSP_FIX.md` - Full explanation of CSP issue and solution
- `MARKDOWN_RENDERING_FIX.md` - Original markdown rendering implementation
- `IMPLEMENTATION_COMPLETE.md` - Complete TS-0006 implementation
